# FuckBase 仕様書

## プロジェクト概要

FuckBaseは、Goで実装されたHTTPベースのデータベースプロダクトです。シンプルなキーバリューストアの機能に加え、インデックス機能とS3連携機能を備えています。

## 開発方針

- **テスト駆動開発**: すべての機能に対して必ずテストを書く
- **迅速な実装**: 機能を素早く実装し、継続的に改善する
- **継続的テスト**: 実装後、頻繁にテストを実行して品質を確保する
- **簡潔なドキュメント**: 必要最小限のドキュメントを維持し、不要になったドキュメントやコードは積極的に削除する

## 技術仕様

### データベース構造

FuckBaseは以下の2つの主要構造を持ちます：

1. **Set（データ本体）**
   - 各Setは一意の`name`を持つ
   - 各データエントリは`key`と`value`のペアで構成される
   - `value`はMessagePackでエンコードされる

2. **Index（インデックス）**
   - 形式: `{setname: string, value: string}`
   - 各Setに対して複数のインデックスを定義可能
   - インデックスを使用してデータの検索とソートが可能

### API インターフェース

すべての操作はHTTP POSTリクエストを通じて行われます。

#### 基本エンドポイント（予定）

1. **データベース操作**
   - `/create` - データベースの作成
   - `/drop` - データベースの削除

2. **Set操作**
   - `/set/create` - 新しいSetの作成
   - `/set/get` - キーによるデータの取得
   - `/set/put` - データの挿入/更新
   - `/set/delete` - データの削除
   - `/set/list` - Setの一覧取得

3. **インデックス操作**
   - `/index/create` - インデックスの作成
   - `/index/drop` - インデックスの削除
   - `/index/query` - インデックスを使用したクエリ

### データエンコーディング

- すべての値（value）はMessagePackを使用してエンコードされます
- これにより、様々なデータ型を効率的に保存できます

### インデックスメカニズム

#### 基本インデックス

- インデックスは後から追加可能
- インデックス追加時には、既存のSetデータをスキャンしてMessagePackをデコードし、インデックス値を抽出
- インデックスフィールドを持たないデータはインデックスに追加されません
- インデックスを使用したクエリでは、指定された値に一致するデータを検索できます

#### ソート可能インデックス

FuckBaseは、フィルタリングとソートを組み合わせた高度なクエリをサポートするために、ソート可能インデックスを提供します。

##### 主要機能

- **複合フィールドインデックス**: プライマリフィールド（フィルタリング用）と1つ以上のセカンダリフィールド（ソート用）を指定可能
- **フィルタリング**: プライマリフィールドの値に基づいてデータを絞り込み
- **ソート機能**: フィルタリングされた結果を、セカンダリフィールドでソート
- **ソート順序**: 各ソートフィールドごとに昇順・降順の指定が可能
- **複数条件ソート**: 複数のセカンダリフィールドによる多段ソートをサポート
- **Null値の扱い**: ソートフィールドが存在しないエントリは、ソート結果の最後に配置
- **ページング機能**: 大量の結果を効率的に取得するためのオフセットとリミットの指定が可能

##### インデックス構造

ソート可能インデックスは、以下のような構造を持ちます：

```
{
  プライマリフィールド値1: {
    キー1: { ソートフィールド1: 値, ソートフィールド2: 値, ... },
    キー2: { ソートフィールド1: 値, ソートフィールド2: 値, ... },
    ...
  },
  プライマリフィールド値2: {
    ...
  },
  ...
}
```

##### 使用例

1. **基本的なフィルタリングとソート**:
   - 「カテゴリが"電子機器"の商品を、価格の安い順に表示」
   - プライマリフィールド: カテゴリ, ソートフィールド: 価格, ソート順: 昇順

2. **複数フィールドによるソート**:
   - 「部署が"営業"の従業員を、役職の昇順、その中で給与の高い順にソート」
   - プライマリフィールド: 部署, ソートフィールド: [役職, 給与], ソート順: [昇順, 降順]

3. **ページング付きクエリ**:
   - 「カテゴリが"書籍"の商品を、出版日の新しい順に、10件ずつ表示」
   - プライマリフィールド: カテゴリ, ソートフィールド: 出版日, ソート順: 降順, オフセット: 0, リミット: 10

##### API

ソート可能インデックスは、以下のAPIを通じて操作できます：

- **インデックス作成**: `/index/create/sortable` - プライマリフィールドとソートフィールドを指定
- **クエリ実行**: `/index/query/sorted` - プライマリフィールド値、ソートフィールド、ソート順、ページングパラメータを指定
- **複数フィールドソート**: `/index/query/multi-sorted` - 複数のソートフィールドとそれぞれのソート順を指定

これにより、データベース操作のみでフィルタリングとソートを効率的に実行でき、アプリケーション側での追加処理が不要になります。

### S3連携機能

S3連携機能は、基本機能が実装された後に追加される予定です：

1. **データ復元**
   - 起動時にS3（または互換サービス）からデータを復元

2. **バックアップ**
   - 実行中に定期的にS3にデータをバックアップ

## サーバー設定

### コマンドラインオプション

FuckBaseサーバーは起動時に以下のコマンドラインオプションをサポートします：

```
fuckbase [options]
```

#### 基本オプション

- `--port <port>`: サーバーが待ち受けるポート番号（デフォルト: 8080）
- `--host <host>`: サーバーがバインドするホストアドレス（デフォルト: 0.0.0.0）
- `--data-dir <path>`: データファイルを保存するディレクトリ（デフォルト: ./data）

#### 管理ユーザー設定

- `--admin-username <username>`: 管理ユーザーのユーザー名
- `--admin-password <password>`: 管理ユーザーのパスワード

管理ユーザーは、データベースの作成や削除などの管理操作を実行するための特別な権限を持ちます。管理ユーザーが設定されている場合、管理操作を実行するには認証が必要になります。管理ユーザーが設定されていない場合、誰でも管理操作を実行できます。

#### S3連携オプション

- `--s3-endpoint <url>`: S3互換サービスのエンドポイントURL
- `--s3-bucket <name>`: バックアップに使用するバケット名
- `--s3-access-key <key>`: S3アクセスキー
- `--s3-secret-key <key>`: S3シークレットキー
- `--s3-region <region>`: S3リージョン（デフォルト: us-east-1）
- `--backup-interval <minutes>`: 自動バックアップの間隔（分単位、デフォルト: 60）

#### ログオプション

- `--log-level <level>`: ログレベル（debug, info, warn, error）（デフォルト: info）
- `--log-file <path>`: ログファイルのパス（デフォルト: stdout）

### 環境変数

コマンドラインオプションの代わりに、以下の環境変数を使用して設定することも可能です：

- `FUCKBASE_PORT`: サーバーポート
- `FUCKBASE_HOST`: バインドするホスト
- `FUCKBASE_DATA_DIR`: データディレクトリ
- `FUCKBASE_ADMIN_USERNAME`: 管理ユーザー名
- `FUCKBASE_ADMIN_PASSWORD`: 管理ユーザーパスワード
- `FUCKBASE_S3_ENDPOINT`: S3エンドポイント
- `FUCKBASE_S3_BUCKET`: S3バケット
- `FUCKBASE_S3_ACCESS_KEY`: S3アクセスキー
- `FUCKBASE_S3_SECRET_KEY`: S3シークレットキー
- `FUCKBASE_S3_REGION`: S3リージョン
- `FUCKBASE_BACKUP_INTERVAL`: バックアップ間隔
- `FUCKBASE_LOG_LEVEL`: ログレベル
- `FUCKBASE_LOG_FILE`: ログファイル

## 認証

- データベース作成時に認証情報を設定可能
- 認証情報が設定されていない場合は、制限なくアクセス可能
- 管理ユーザーが設定されている場合、管理操作（データベースの作成/削除など）には管理ユーザーの認証が必要

## 実装詳細

### データストレージ

- 内部的にはメモリ上でデータを管理
- 永続化はS3連携機能を通じて実現

### インデックス実装

インデックス作成時のフロー：
1. 対象のSetをスキャン
2. 各エントリのMessagePackデータをデコード
3. 指定されたフィールドの値を抽出してインデックスを構築
   - フィールドが存在しない場合は、そのエントリはインデックスに追加されない
4. インデックスを保存

データ追加/更新時のインデックス更新フロー：
1. データがSetに追加/更新される
2. 関連するインデックスを特定
3. MessagePackデータをデコードし、インデックスフィールドの値を抽出
   - フィールドが存在しない場合は、インデックスは更新されない
4. インデックスを更新

### エラーハンドリング

- 適切なHTTPステータスコードとエラーメッセージを返す
- クライアントエラー（400番台）とサーバーエラー（500番台）を適切に区別